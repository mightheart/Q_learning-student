# è·¯å¾„æˆæœ¬åˆ†ææ–‡æ¡£

## æ¦‚è¿°

æœ¬é¡¹ç›®ä¸­ï¼Œè·¯å¾„æˆæœ¬ï¼ˆWalking Costï¼‰ç”¨äº **Dijkstra æœ€çŸ­è·¯å¾„ç®—æ³•**ï¼Œå¸®åŠ©å­¦ç”Ÿé€‰æ‹©ä»èµ·ç‚¹åˆ°ç›®çš„åœ°çš„æœ€ä¼˜è·¯å¾„ã€‚æˆæœ¬çš„æ ¸å¿ƒæŒ‡æ ‡æ˜¯ **æ—…è¡Œæ—¶é—´ï¼ˆTravel Timeï¼‰**ã€‚

---

## 1. æ ¸å¿ƒæ•°æ®ç»“æ„

### 1.1 `Path` ç±»ï¼ˆè·¯å¾„è¾¹ï¼‰

**æ–‡ä»¶ä½ç½®**: `src/campus/graph.py` (ç¬¬ 30-58 è¡Œ)

```python
@dataclass
class Path:
    """Represents a traversal edge between two buildings."""
    
    start: Building          # èµ·å§‹å»ºç­‘
    end: Building            # ç»ˆç‚¹å»ºç­‘
    length: float            # è·¯å¾„ç‰©ç†é•¿åº¦ï¼ˆç±³ï¼‰
    difficulty: float = 1.0  # éš¾åº¦ç³»æ•°ï¼ˆé»˜è®¤ 1.0ï¼‰
    capacity: Optional[int] = None  # å®¹é‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰
    current_students: List[str] = field(default_factory=list)  # å½“å‰ä½¿ç”¨è€…
```

#### å…³é”®å±æ€§è¯´æ˜

| å±æ€§ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `length` | `float` | è·¯å¾„çš„ç‰©ç†è·ç¦»ï¼ˆç±³ï¼‰ | 80, 120, 200 |
| `difficulty` | `float` | éš¾åº¦ç³»æ•°ï¼ˆå¹³åœ°=1.0ï¼Œæ¥¼æ¢¯/æ–œå¡>1.0ï¼‰ | 1.0, 1.2 |
| `capacity` | `Optional[int]` | æœ€å¤§åŒæ—¶å®¹çº³äººæ•°ï¼ˆ`None`=æ— é™åˆ¶ï¼‰ | 1, 10, None |
| `current_students` | `List[str]` | å½“å‰æ­£åœ¨æ­¤è·¯å¾„ä¸Šçš„å­¦ç”ŸIDåˆ—è¡¨ | ["CS1-001", "MATH-042"] |

---

## 2. æˆæœ¬è®¡ç®—å…¬å¼

### 2.1 `get_travel_time()` æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `src/campus/graph.py` (ç¬¬ 49-52 è¡Œ)

```python
def get_travel_time(self, base_speed: float = 80.0) -> float:
    """Calculate travel time (minutes) for this path."""
    
    return (self.length * self.difficulty) / base_speed
```

#### å…¬å¼è§£æ

$$
\text{Travel Time (minutes)} = \frac{\text{length (meters)} \times \text{difficulty}}{\text{base\_speed (m/min)}}
$$

#### å‚æ•°è¯´æ˜

- **`base_speed`**: åŸºå‡†æ­¥è¡Œé€Ÿåº¦ï¼Œé»˜è®¤ **80 ç±³/åˆ†é’Ÿ** (çº¦ 4.8 å…¬é‡Œ/å°æ—¶)
- **`length`**: è·¯å¾„çš„å®é™…è·ç¦»ï¼ˆç±³ï¼‰
- **`difficulty`**: 
  - `1.0` = å¹³åœ°ï¼ˆæ­£å¸¸é€Ÿåº¦ï¼‰
  - `1.2` = æœ‰æ¥¼æ¢¯/æ–œå¡ï¼ˆé€Ÿåº¦é™ä½ 20%ï¼‰
  - `1.5` = æ›´é™¡å³­çš„è·¯å¾„

#### è®¡ç®—ç¤ºä¾‹

| åœºæ™¯ | length | difficulty | base_speed | Travel Time |
|------|--------|------------|------------|-------------|
| å¹³åœ° 80 ç±³ | 80 | 1.0 | 80 | **1.0 åˆ†é’Ÿ** |
| å¹³åœ° 200 ç±³ | 200 | 1.0 | 80 | **2.5 åˆ†é’Ÿ** |
| æ¥¼æ¢¯ 120 ç±³ | 120 | 1.2 | 80 | **1.8 åˆ†é’Ÿ** |
| é™¡å¡ 100 ç±³ | 100 | 1.5 | 80 | **1.875 åˆ†é’Ÿ** |

---

## 3. Dijkstra æœ€çŸ­è·¯å¾„ç®—æ³•ä¸­çš„åº”ç”¨

### 3.1 `find_shortest_path()` æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `src/campus/graph.py` (ç¬¬ 101-142 è¡Œ)

```python
def find_shortest_path(self, start_id: str, end_id: str) -> Tuple[float, List[Building]]:
    """Run Dijkstra to find the lowest travel-time route."""
    
    distances: Dict[str, float] = {start_id: 0.0}
    previous: Dict[str, str] = {}
    heap: List[Tuple[float, str]] = [(0.0, start_id)]
    visited: set[str] = set()

    while heap:
        current_time, current_id = heappop(heap)
        if current_id in visited:
            continue
        visited.add(current_id)

        if current_id == end_id:
            break

        current_building = self.buildings[current_id]
        for path in current_building.paths:
            if not path.has_capacity():  # ğŸ”´ æ£€æŸ¥å®¹é‡é™åˆ¶
                continue
            neighbor_id = path.end.building_id
            if neighbor_id in visited:
                continue

            new_time = current_time + path.get_travel_time()  # ğŸ”´ æ ¸å¿ƒï¼šç´¯åŠ æ—…è¡Œæ—¶é—´
            if new_time < distances.get(neighbor_id, inf):
                distances[neighbor_id] = new_time
                previous[neighbor_id] = current_id
                heappush(heap, (new_time, neighbor_id))

    if end_id not in distances:
        raise ValueError(f"No path found from {start_id} to {end_id}")

    return distances[end_id], self._reconstruct_route(previous, start_id, end_id)
```

#### å…³é”®ç‚¹

1. **æƒé‡ = æ—…è¡Œæ—¶é—´**: 
   ```python
   new_time = current_time + path.get_travel_time()
   ```
   æ¯æ¡è¾¹çš„æƒé‡å°±æ˜¯é€šè¿‡ `get_travel_time()` è®¡ç®—çš„æ—…è¡Œæ—¶é—´ã€‚

2. **å®¹é‡çº¦æŸ**: 
   ```python
   if not path.has_capacity():
       continue
   ```
   å¦‚æœè·¯å¾„å·²æ»¡ï¼ˆ`capacity` è¾¾åˆ°ä¸Šé™ï¼‰ï¼Œåˆ™è¯¥è¾¹åœ¨æœ¬æ¬¡è·¯å¾„è§„åˆ’ä¸­è¢«å¿½ç•¥ã€‚

3. **ä¼˜å…ˆé˜Ÿåˆ—**: 
   ä½¿ç”¨ Python çš„ `heapq`ï¼Œå§‹ç»ˆé€‰æ‹©å½“å‰ç´¯è®¡æˆæœ¬æœ€å°çš„èŠ‚ç‚¹æ‰©å±•ã€‚

---

## 4. å®é™…åœ°å›¾ä¸­çš„è·¯å¾„å®šä¹‰

### 4.1 åœ°å›¾è·¯å¾„æ•°æ®

**æ–‡ä»¶ä½ç½®**: `src/campus/data.py` (ç¬¬ 69+ è¡Œ)

```python
paths_data = [
    # æ ¼å¼: (èµ·ç‚¹, ç»ˆç‚¹, é•¿åº¦(ç±³), éš¾åº¦, å®¹é‡)
    
    # === åŒ—éƒ¨æ•™å­¦åŒº (å¹³åœ°) ===
    ("D3a", "D3b", 80, 1.0, None),      # æ•™å­¦æ¥¼ D æ¨ªå‘è¿æ¥ï¼ˆ80ç±³ï¼Œæ— å®¹é‡é™åˆ¶ï¼‰
    ("D3b", "D3c", 80, 1.0, None),
    
    # === è¿æ¥å›¾ä¹¦é¦†ï¼ˆä¸­ç­‰è·ç¦»ï¼‰ ===
    ("D3d", "library", 120, 1.0, None), # 120ç±³åˆ°å›¾ä¹¦é¦†
    
    # === è¿æ¥æ¡¥æ¢ï¼ˆè·¨åŒºåŸŸï¼‰ ===
    ("D3a", "bridge_west", 150, 1.0, None),
    ("library", "bridge_mid_left", 150, 1.0, None),
    
    # === å—éƒ¨ç”Ÿæ´»åŒº ===
    ("canteen", "gym", 200, 1.0, None),
    ("gym", "playground", 80, 1.0, None),
    
    # === ç¤ºä¾‹ï¼šæœ‰å®¹é‡é™åˆ¶çš„è·¯å¾„ ===
    # ("A", "C", 60, 1.0, 1)  # å®¹é‡=1ï¼ˆä»…å…è®¸1äººåŒæ—¶é€šè¿‡ï¼‰
]
```

#### è·¯å¾„ç»Ÿè®¡

| è·ç¦»èŒƒå›´ | æ•°é‡ | è¯´æ˜ | å¹³å‡æ—…è¡Œæ—¶é—´ |
|---------|------|------|--------------|
| 80 ç±³ | 12 æ¡ | ç›¸é‚»å»ºç­‘ | **1.0 åˆ†é’Ÿ** |
| 120-180 ç±³ | 10 æ¡ | åŒºåŸŸå†…è¿æ¥ | **1.5-2.25 åˆ†é’Ÿ** |
| 200-250 ç±³ | 4 æ¡ | è·¨åŒºåŸŸè¿æ¥ | **2.5-3.1 åˆ†é’Ÿ** |

---

## 5. å­¦ç”Ÿç§»åŠ¨ä¸­çš„æˆæœ¬ä½¿ç”¨

### 5.1 å­¦ç”Ÿè·¯å¾„è§„åˆ’

**æ–‡ä»¶ä½ç½®**: `src/campus/student.py` (ç¬¬ 44-71 è¡Œ)

```python
def plan_next_move(self, current_time: str, graph: Graph) -> Optional[ScheduleEvent]:
    """Plan a route towards the next scheduled event."""
    
    next_event = self.schedule.get_next_event(current_time)
    if next_event is None:
        return None

    target = graph.get_building(next_event.building_id)
    
    # ğŸ”´ è°ƒç”¨ Dijkstra ç®—æ³•è®¡ç®—æœ€çŸ­è·¯å¾„
    total_time, route = graph.find_shortest_path(
        self.current_location.building_id, 
        target.building_id
    )
    
    # å°†è·¯å¾„åˆ†è§£ä¸ºå¤šä¸ª _Segmentï¼ˆæ¯ä¸ª segment å¯¹åº”ä¸€æ¡ Pathï¼‰
    segments: List[_Segment] = []
    for start, end in zip(route, route[1:]):
        path = graph.get_path(start.building_id, end.building_id)
        segments.append(_Segment(
            path=path, 
            remaining_time=path.get_travel_time()  # ğŸ”´ åˆå§‹åŒ–å‰©ä½™æ—¶é—´
        ))
    
    self.state = "moving"
    self.path_to_destination = route
    self._segments = segments
    return next_event
```

### 5.2 `_Segment` ç±»ï¼ˆè·¯å¾„åˆ†æ®µï¼‰

**æ–‡ä»¶ä½ç½®**: `src/campus/student.py` (ç¬¬ 11-30 è¡Œ)

```python
@dataclass
class _Segment:
    """Represents progress travelling along a path."""
    
    path: Path           # å½“å‰è·¯å¾„
    remaining_time: float  # å‰©ä½™æ—…è¡Œæ—¶é—´ï¼ˆåˆå§‹å€¼ = path.get_travel_time()ï¼‰
    started: bool = False  # æ˜¯å¦å·²å¼€å§‹ï¼ˆç”¨äºå®¹é‡å ç”¨ï¼‰

    def step(self, student_id: str, delta_time: float) -> float:
        """Advance along the path and return leftover time."""
        
        if not self.started:
            if not self.path.has_capacity():
                raise RuntimeError("Path capacity exceeded")
            self.path.current_students.append(student_id)  # å ç”¨å®¹é‡
            self.started = True

        if delta_time < self.remaining_time:
            self.remaining_time -= delta_time  # å‡å°‘å‰©ä½™æ—¶é—´
            return 0.0

        # å®Œæˆå½“å‰è·¯å¾„ï¼Œè¿”å›å¤šä½™çš„æ—¶é—´
        delta_time -= self.remaining_time
        self.remaining_time = 0.0
        if student_id in self.path.current_students:
            self.path.current_students.remove(student_id)  # é‡Šæ”¾å®¹é‡
        return delta_time
```

---

## 6. æµ‹è¯•æ¡ˆä¾‹

### 6.1 åŸºæœ¬è·¯å¾„æˆæœ¬æµ‹è¯•

**æ–‡ä»¶ä½ç½®**: `src/tests/test_graph.py` (ç¬¬ 19-23 è¡Œ)

```python
def test_shortest_path_prefers_lower_time(self) -> None:
    total_time, route = self.graph.find_shortest_path("A", "C")
    names = [building.name for building in route]
    self.assertEqual(names, ["Gate", "Library", "Cafeteria"])
    self.assertAlmostEqual(total_time, (80 + 40) / 80.0)  # (120ç±³) / (80ç±³/åˆ†é’Ÿ) = 1.5åˆ†é’Ÿ
```

### 6.2 å®¹é‡é™åˆ¶æµ‹è¯•

**æ–‡ä»¶ä½ç½®**: `src/tests/test_graph.py` (ç¬¬ 25-29 è¡Œ)

```python
def test_capacity_restrictions_block_edges(self) -> None:
    direct = self.graph.connect_buildings("A", "C", length=50, difficulty=1.0, capacity=1)
    direct.current_students.append("student-1")  # å ç”¨å”¯ä¸€å®¹é‡
    
    total_time, route = self.graph.find_shortest_path("A", "C")
    self.assertGreater(total_time, direct.get_travel_time())  # è¢«è¿«ç»•è·¯ï¼Œæ—¶é—´æ›´é•¿
    self.assertNotIn("Cafeteria", [building.name for building in route[:2]])
```

---

## 7. å½±å“è·¯å¾„æˆæœ¬çš„å› ç´ æ€»ç»“

| å› ç´  | å½±å“æ–¹å¼ | å®ç°ä½ç½® |
|------|---------|----------|
| **ç‰©ç†è·ç¦»** (`length`) | ç›´æ¥æ­£æ¯”ï¼šè·ç¦»è¶Šé•¿ï¼Œæˆæœ¬è¶Šé«˜ | `Path.length` |
| **è·¯å¾„éš¾åº¦** (`difficulty`) | ç³»æ•°ä¹˜æ³•ï¼šéš¾åº¦è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šæ…¢ | `Path.difficulty` |
| **åŸºå‡†é€Ÿåº¦** (`base_speed`) | åˆ†æ¯ï¼šé€Ÿåº¦è¶Šå¿«ï¼Œæˆæœ¬è¶Šä½ | `Path.get_travel_time()` |
| **å®¹é‡é™åˆ¶** (`capacity`) | å¸ƒå°”çº¦æŸï¼šæ»¡å‘˜æ—¶æ­¤è·¯å¾„ä¸å¯ç”¨ | `Path.has_capacity()` |
| **å½“å‰ä½¿ç”¨è€…** (`current_students`) | å†³å®šå®¹é‡æ˜¯å¦é¥±å’Œ | `Path.current_students` |

---

## 8. å®é™…åº”ç”¨åœºæ™¯

### 8.1 æ—©é«˜å³°åœºæ™¯ï¼ˆ07:30-08:00ï¼‰

- å¤§é‡å­¦ç”Ÿä»å®¿èˆ â†’ é£Ÿå ‚ â†’ æ•™å­¦æ¥¼
- æ¡¥æ¢æˆä¸ºç“¶é¢ˆï¼ˆæ‰€æœ‰å—åŒ—ç§»åŠ¨å¿…é¡»ç»è¿‡ 4 åº§æ¡¥ï¼‰
- å¦‚æœæ¡¥è®¾ç½®å®¹é‡é™åˆ¶ï¼Œåç»­å­¦ç”Ÿå°†è¢«è¿«é€‰æ‹©æ›´è¿œçš„æ¡¥
- **æˆæœ¬**: åŸè·¯å¾„ 2 åˆ†é’Ÿï¼Œç»•è·¯å¯èƒ½å˜æˆ 3.5 åˆ†é’Ÿ

### 8.2 è·¯å¾„é€‰æ‹©ç¤ºä¾‹

å‡è®¾å­¦ç”Ÿåœ¨ D5aï¼ˆå®¿èˆï¼‰ï¼Œç›®æ ‡æ˜¯ D3aï¼ˆæ•™å®¤ï¼‰ï¼š

**é€‰é¡¹1ï¼šè¥¿æ¡¥**
```
D5a â†’ bridge_west â†’ D3a
è·¯å¾„: 150m + 150m = 300m
æˆæœ¬: 300 / 80 = 3.75 åˆ†é’Ÿ
```

**é€‰é¡¹2ï¼šä¸­å·¦æ¡¥**
```
D5a â†’ gym â†’ bridge_mid_left â†’ D3d â†’ D3c â†’ D3b â†’ D3a
è·¯å¾„: 180m + 150m + 80m + 80m + 80m = 570m
æˆæœ¬: 570 / 80 = 7.125 åˆ†é’Ÿ
```

Dijkstra ç®—æ³•ä¼šé€‰æ‹© **é€‰é¡¹1**ï¼ˆæ›´çŸ­æ—¶é—´ï¼‰ã€‚

ä½†å¦‚æœ `bridge_west` å®¹é‡å·²æ»¡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹© **é€‰é¡¹2**ã€‚

---

## 9. æ‰©å±•å¯èƒ½æ€§

### 9.1 åŠ¨æ€æˆæœ¬

- **æ—¶é—´å› ç´ **: ä¸åŒæ—¶æ®µè·¯å¾„æ‹¥å µç¨‹åº¦ä¸åŒ
  ```python
  def get_travel_time(self, base_speed: float = 80.0, time_of_day: str = "08:00") -> float:
      congestion_factor = 1.2 if time_of_day in PEAK_HOURS else 1.0
      return (self.length * self.difficulty * congestion_factor) / base_speed
  ```

### 9.2 ä¸ªæ€§åŒ–æˆæœ¬

- **ä¸åŒå­¦ç”Ÿé€Ÿåº¦**: è¿åŠ¨å‘˜æ­¥è¡Œæ›´å¿«ï¼Œæ®‹ç–¾å­¦ç”Ÿéœ€è¦é¿å¼€æ¥¼æ¢¯
  ```python
  class Student:
      walking_speed: float = 80.0  # é»˜è®¤80ï¼Œè¿åŠ¨å‘˜å¯èƒ½æ˜¯90
      avoid_stairs: bool = False    # æ®‹ç–¾å­¦ç”Ÿä¸ºTrue
  ```

### 9.3 ç¯å¢ƒå› ç´ 

- **å¤©æ°”å½±å“**: é›¨å¤©æˆ·å¤–è·¯å¾„æˆæœ¬æé«˜
- **å»ºç­‘ç»´æŠ¤**: æŸäº›è·¯å¾„ä¸´æ—¶å…³é—­

---

## 10. æ€»ç»“

### æ ¸å¿ƒå…¬å¼

$$
\text{Cost} = \frac{\text{Length} \times \text{Difficulty}}{\text{BaseSpeed}}
$$

### å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | å…³é”®ç±»/å‡½æ•° | ä½œç”¨ |
|------|------------|------|
| `src/campus/graph.py` | `Path.get_travel_time()` | **è®¡ç®—å•æ¡è·¯å¾„æˆæœ¬** |
| `src/campus/graph.py` | `Graph.find_shortest_path()` | **Dijkstra æœ€çŸ­è·¯å¾„** |
| `src/campus/student.py` | `Student.plan_next_move()` | è°ƒç”¨ç®—æ³•è§„åˆ’è·¯å¾„ |
| `src/campus/student.py` | `_Segment.step()` | æŒ‰æˆæœ¬æ¨è¿›ç§»åŠ¨ |
| `src/campus/data.py` | `create_campus_map()` | å®šä¹‰æ‰€æœ‰è·¯å¾„å‚æ•° |

### æ•°æ®æµå‘

```
å®šä¹‰è·¯å¾„ (data.py)
    â†“
Path.get_travel_time() è®¡ç®—æˆæœ¬
    â†“
Graph.find_shortest_path() ä½¿ç”¨æˆæœ¬è¿è¡Œ Dijkstra
    â†“
Student.plan_next_move() è·å–æœ€ä¼˜è·¯å¾„
    â†“
_Segment.step() æŒ‰æˆæœ¬æ¨è¿›å­¦ç”Ÿç§»åŠ¨
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-22  
**ä½œè€…**: AI Assistant  
**é¡¹ç›®**: Campus Life Simulation
